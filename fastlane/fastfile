default_platform(:ios)

platform :ios do
  desc "ðŸ“¦ Build and upload to TestFlight"
  lane :beta do
    # ðŸ§© Authenticate with App Store Connect via API Key
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      in_house: false
    )

    # ðŸ§© Clean & build the iOS app (manual signing)
    gym(
      workspace: "ios/Runner.xcworkspace",  # CocoaPods workspace
      scheme: "Runner",
      export_method: "app-store",
      clean: true,
      silent: true,
      include_symbols: false,
      include_bitcode: false,
      export_options: {
        compileBitcode: false,
        signingStyle: "manual",
        provisioningProfiles: {
          "com.inviteeME" => "EventApp_AppStore"
        },
        teamID: "3QTL6CD7P2"
      }
    )

    # ðŸ§© Upload to TestFlight
    pilot(
      skip_submission: true,                   # skip review submission
      skip_waiting_for_build_processing: true  # faster CI
    )

    UI.success("âœ… Successfully uploaded build to TestFlight!")
  end

  desc "ðŸš€ Release app to App Store"
  lane :release do
    # ðŸ§© Authenticate with App Store Connect (API key)
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      in_house: false
    )

    # ðŸ§© Clean & build release app (manual signing)
    gym(
      workspace: "ios/Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      clean: true,
      silent: true,
      include_symbols: true,
      include_bitcode: false,
      export_options: {
        compileBitcode: false,
        signingStyle: "manual",
        provisioningProfiles: {
          "com.inviteeME" => "EventApp_AppStore"
        },
        teamID: "3QTL6CD7P2"
      }
    )

    # ðŸ§© Upload & auto-submit to App Store
    deliver(
      force: true,              # non-interactive mode
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: true
    )

    UI.success("ðŸŽ‰ App successfully uploaded to App Store for review!")
  end
end
